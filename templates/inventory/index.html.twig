{% extends 'base.html.twig' %}

{% block title %}Inventario Funcional{% endblock %}

{% block stylesheets %}
<style>
    .inventory-dashboard {
        position: sticky; top: 0; z-index: 1000;
        background: #1e1e1e; color: white; padding: 15px;
        border-bottom: 3px solid #0d6efd;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .skin-card {
        cursor: pointer; transition: transform 0.2s, border 0.2s;
        border: 2px solid transparent; background: #2b2b2b; color: #fff;
    }
    .skin-card:hover { transform: translateY(-5px); }
    
    /* Clase que añade JS cuando seleccionas */
    .skin-card.selected {
        border-color: #28a745; /* Verde */
        background-color: #1a3c25;
        box-shadow: 0 0 10px #28a745;
    }
    
    .price-tag { color: #0dcaf0; font-weight: bold; }
    .total-display { font-size: 2rem; font-weight: bold; color: #28a745; }
</style>
{% endblock %}

{% block body %}
<div class="inventory-dashboard">
    <div>
        <strong>Usuario:</strong> {{ app.user }} | 
        <a href="{{ path('auth_logout') }}" class="text-danger">Desconectar</a>
    </div>
    <div>
        <button onclick="selectAll()" class="btn btn-sm btn-outline-light">Todo</button>
        <button onclick="clearSelection()" class="btn btn-sm btn-outline-light">Nada</button>
    </div>
    <div class="total-display">
        Total: $<span id="total-price">0.00</span>
    </div>
</div>

<div class="container mt-4">
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    <div class="row g-3" id="inventory-grid">
        {% for item in items %}
            <div class="col-6 col-md-3 col-lg-2">
                <div class="card h-100 skin-card" 
                     onclick="toggleItem(this, {{ item.price }})" 
                     data-price="{{ item.price }}">
                    
                    <img src="{{ item.image }}" class="card-img-top p-2" alt="{{ item.name }}">
                    <div class="card-body p-2 text-center">
                        <small class="card-title d-block text-truncate" title="{{ item.name }}">
                            {{ item.name }}
                        </small>
                        <div class="price-tag">${{ item.price|number_format(2) }}</div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center text-white">
                <p>No se encontraron items o el inventario es privado.</p>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    let totalPrice = 0.0;

    function toggleItem(element, price) {
        // Convertir precio a float por seguridad
        price = parseFloat(price);

        if (element.classList.contains('selected')) {
            // Deseleccionar
            element.classList.remove('selected');
            totalPrice -= price;
        } else {
            // Seleccionar
            element.classList.add('selected');
            totalPrice += price;
        }
        updateDisplay();
    }

    function selectAll() {
        const cards = document.querySelectorAll('.skin-card');
        totalPrice = 0;
        cards.forEach(card => {
            card.classList.add('selected');
            totalPrice += parseFloat(card.getAttribute('data-price'));
        });
        updateDisplay();
    }

    function clearSelection() {
        const cards = document.querySelectorAll('.skin-card');
        cards.forEach(card => card.classList.remove('selected'));
        totalPrice = 0;
        updateDisplay();
    }

    function updateDisplay() {
        // Evitar números negativos por errores de redondeo flotante
        if (totalPrice < 0) totalPrice = 0;
        document.getElementById('total-price').innerText = totalPrice.toFixed(2);
    }
</script>
{% endblock %}