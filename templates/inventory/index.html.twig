{% extends 'base.html.twig' %}

{% block title %}Inventario{% endblock %}

{# SIN BLOQUE DE CSS #}

{% block body %}
<div class="sticky-top bg-dark text-white p-3 mb-4 d-flex justify-content-between align-items-center shadow">
    <div>
        <i class="fab fa-steam"></i>
        <strong>Usuario:</strong> {{ steamUser|default('Invitado') }} | 
        <a href="{{ path('auth_logout') }}" class="text-danger text-decoration-none fw-bold">Salir</a>
    </div>
    
    <div class="btn-group">
        <button onclick="selectAll()" class="btn btn-sm btn-outline-light">Seleccionar Todo</button>
        <button onclick="clearSelection()" class="btn btn-sm btn-outline-danger">Limpiar</button>
    </div>

    <div class="fs-4 fw-bold text-success">
        Total: $<span id="total-price">0.00</span>
    </div>
</div>

<div class="container pb-5">
    {# Mensajes de error #}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    <div class="row g-3" id="inventory-grid">
        {% for item in items|default([]) %}
            <div class="col-6 col-md-4 col-lg-2">
                <div class="card h-100 shadow-sm" 
                     role="button"
                     onclick="toggleItem(this, {{ item.price }})" 
                     data-price="{{ item.price }}"
                     style="cursor: pointer;"> 
                    
                    <div class="card-body text-center p-2 d-flex flex-column justify-content-between">
                        <img src="{{ item.image }}" class="img-fluid mb-2" alt="{{ item.name }}" style="max-height: 100px; object-fit: contain;">
                        
                        <div>
                            <small class="d-block text-truncate fw-bold mb-1" title="{{ item.name }}">
                                {{ item.name }}
                            </small>
                            <div class="mb-1">
                                <span class="badge bg-primary">${{ item.price|number_format(2) }}</span>
                            </div>
                            {% if item.float is defined and item.float is not null %}
                                <div class="text-xs text-muted" style="font-size: 0.7rem;">
                                    Float: {{ item.float|number_format(4) }}<br>
                                    Pattern: {{ item.pattern|default('?') }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center mt-5">
                <div class="alert alert-warning">
                    <h4>Inventario vacío o privado</h4>
                    <p>No hemos podido cargar tus items. Revisa que tu perfil de Steam sea público.</p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    let totalPrice = 0.0;

    function toggleItem(cardElement, price) {
        price = parseFloat(price);

        // Usamos clases de Bootstrap para indicar selección en lugar de CSS propio
        // 'border-success', 'bg-success', 'text-white' son clases estándar
        if (cardElement.classList.contains('border-success')) {
            // DESELECCIONAR: Quitar estilos de Bootstrap
            cardElement.classList.remove('border-success', 'border', 'border-3', 'bg-success', 'bg-opacity-25');
            totalPrice -= price;
        } else {
            // SELECCIONAR: Añadir estilos de Bootstrap (Borde verde y fondo verdoso)
            cardElement.classList.add('border-success', 'border', 'border-3', 'bg-success', 'bg-opacity-25');
            totalPrice += price;
        }
        updateDisplay();
    }

    function selectAll() {
        const cards = document.querySelectorAll('.card[onclick]'); // Solo las cartas con onclick
        totalPrice = 0;
        
        cards.forEach(card => {
            // Resetear visualmente primero para no duplicar
            card.classList.add('border-success', 'border', 'border-3', 'bg-success', 'bg-opacity-25');
            
            // Sumar precio
            const price = parseFloat(card.getAttribute('data-price'));
            totalPrice += price;
        });
        updateDisplay();
    }

    function clearSelection() {
        const cards = document.querySelectorAll('.card[onclick]');
        cards.forEach(card => {
            // Quitar todas las clases de "seleccionado"
            card.classList.remove('border-success', 'border', 'border-3', 'bg-success', 'bg-opacity-25');
        });
        totalPrice = 0;
        updateDisplay();
    }

    function updateDisplay() {
        if (totalPrice < 0.01) totalPrice = 0;
        // Formato moneda US
        document.getElementById('total-price').innerText = totalPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
</script>
{% endblock %}