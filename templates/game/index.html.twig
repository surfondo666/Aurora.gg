{% extends 'base.html.twig' %}

{% block title %}Higher or Lower - CS2 Skins | Aurora.gg
{% endblock %}

{% block body %}
	<div
		class="bg-black min-h-screen text-white overflow-hidden flex flex-col items-center justify-center relative font-sans">

		<!-- Score -->
		<div class="absolute top-16 z-50 bg-black/50 backdrop-blur-md px-6 py-2 rounded-full border border-aurora-gold/30 shadow-[0_0_20px_rgba(255,215,0,0.2)]">
			<span class="text-sm uppercase tracking-widest text-gray-400">Score</span>
			<span id="score" class="text-2xl font-bold text-aurora-gold ml-2">0</span>
		</div>

		<!-- Game Container -->
		<div
			class="w-full max-w-6xl h-screen md:h-[80vh] flex flex-col md:flex-row relative mt-0 md:mt-10" id="game-container">

			<!-- VS Badge -->
			<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-40 bg-aurora-card w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center border-4 border-black text-lg md:text-xl font-black italic shadow-lg">VS</div>

			<!-- Left Panel: Skin 1 -->
			<div class="w-full h-1/2 md:w-1/2 md:h-full relative group overflow-hidden border-b md:border-b-0 md:border-r border-white/5 bg-zinc-900 flex flex-col items-center justify-center p-4 md:p-8 transition-all" id="panel-left">
				<div class="absolute inset-0 bg-gradient-to-b from-black/20 to-black/80 z-10"></div>
				<img id="img-1" src="{{ skin1.image }}" alt="{{ skin1.name }}" class="absolute inset-0 w-full h-full object-contain opacity-50 blur-sm scale-110 group-hover:scale-100 transition-transform duration-700">
				<img id="img-1-main" src="{{ skin1.image }}" class="w-32 h-32 md:w-64 md:h-64 object-contain z-20 drop-shadow-[0_0_30px_rgba(255,255,255,0.1)] animate-float">

				<div class="z-30 text-center mt-4 md:mt-6">
					<h2 id="name-1" class="text-lg md:text-4xl font-black uppercase tracking-tighter mb-1 md:mb-2 px-2">{{ skin1.name }}</h2>
					<div class="text-xl md:text-3xl font-bold text-aurora-green" id="price-1">${{ skin1.price }}</div>
				</div>
			</div>

			<!-- Right Panel: Skin 2 -->
			<div class="w-full h-1/2 md:w-1/2 md:h-full relative group overflow-hidden bg-zinc-800 flex flex-col items-center justify-center p-4 md:p-8 transition-all" id="panel-right">
				<div class="absolute inset-0 bg-gradient-to-b from-black/20 to-black/80 z-10"></div>
				<img id="img-2" src="{{ skin2.image }}" alt="{{ skin2.name }}" class="absolute inset-0 w-full h-full object-contain opacity-50 blur-sm scale-110 group-hover:scale-100 transition-transform duration-700">
				<img id="img-2-main" src="{{ skin2.image }}" class="w-32 h-32 md:w-64 md:h-64 object-contain z-20 drop-shadow-[0_0_30px_rgba(255,255,255,0.1)]">

				<div class="z-30 text-center mt-4 md:mt-6 flex flex-col items-center">
					<h2 id="name-2" class="text-lg md:text-4xl font-black uppercase tracking-tighter mb-2 md:mb-4 px-2">{{ skin2.name }}</h2>

					<div id="controls" class="flex flex-col gap-2 md:gap-3 w-40 md:w-48">
						<button onclick="checkAnswer('higher')" class="bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-2 md:py-3 px-4 md:px-6 rounded-lg uppercase tracking-wider transform hover:scale-105 transition-all shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
							<i class="fa-solid fa-chevron-up"></i>
							Higher
						</button>
						<button onclick="checkAnswer('lower')" class="bg-red-500 hover:bg-red-400 text-black font-bold py-2 md:py-3 px-4 md:px-6 rounded-lg uppercase tracking-wider transform hover:scale-105 transition-all shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
							<i class="fa-solid fa-chevron-down"></i>
							Lower
						</button>
					</div>

					<div id="result-price" class="hidden text-2xl md:text-3xl font-bold mt-2 md:mt-4 animate-in fade-in zoom-in duration-300">
						$<span id="price-2-val"></span>
					</div>
				</div>
			</div>
		</div>

		<!-- Loading Overlay -->
		<div id="loading" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center">
			<i class="fa-solid fa-circle-notch fa-spin text-5xl text-aurora-gold mb-4"></i>
			<p class="text-xl uppercase tracking-widest font-bold">Loading Next Round...</p>
		</div>

		<!-- Game Over Overlay -->
		<div id="game-over" class="fixed inset-0 bg-black/90 z-[70] hidden flex-col items-center justify-center text-center p-4">
			<h1 class="text-6xl font-black text-red-500 mb-2">GAME OVER</h1>
			<p class="text-2xl text-gray-300 mb-8">You scored:
				<span id="final-score" class="text-white font-bold">0</span>
			</p>

			<div class="flex gap-4">
				<button onclick="location.reload()" class="bg-aurora-gold hover:bg-white text-black font-bold py-3 px-8 rounded-full uppercase tracking-wider transition-colors">
					Play Again
				</button>
				<a href="{{ path('app_community') }}" class="border border-white/20 hover:bg-white/10 text-white font-bold py-3 px-8 rounded-full uppercase tracking-wider transition-colors">
					Back to Community
				</a>
			</div>
		</div>

	</div>

	<script>
		let currentScore = 0;
let skin1Id = {{ skin1.id }};
let skin2Id = {{ skin2.id }};

function checkAnswer(choice) {
// Show loading state roughly or define UI feedback
// Ideally we reveal price first, then wait a sec, then move to next.

// 1. Disable buttons
const controls = document.getElementById('controls');
controls.classList.add('opacity-50', 'pointer-events-none');

fetch("{{ path('app_game_check') }}", {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(
{skin1Id: skin1Id, skin2Id: skin2Id, choice: choice}
)
}).then(res => res.json()).then(data => {
if (data.error) {
alert(data.error);
return;
}

// Show price of skin 2
const resultPrice = document.getElementById('result-price');
const price2Val = document.getElementById('price-2-val');

price2Val.innerText = data.price2;
controls.classList.add('hidden');
resultPrice.classList.remove('hidden');

// Determine outcome colors
const rightPanel = document.getElementById('panel-right');

if (data.correct) { // CORRECT
rightPanel.classList.add('bg-emerald-900/50');

setTimeout(() => { // Update Score
currentScore++;
document.getElementById('score').innerText = currentScore;

// Prepare Next Round
loadNextRound(data.nextSkin1, data.nextSkin2);
}, 1500);

} else { // WRONG
rightPanel.classList.add('bg-red-900/50');

setTimeout(() => {
document.getElementById('final-score').innerText = currentScore;
document.getElementById('game-over').classList.remove('hidden');
document.getElementById('game-over').classList.add('flex');
}, 1500);
}
}).catch(err => {
console.error(err);
alert('Something went wrong. Please try refreshing.');
});
}

function loadNextRound(next1, next2) { // Reset UI for next round
const leftPanel = document.getElementById('panel-left');
const rightPanel = document.getElementById('panel-right');
const controls = document.getElementById('controls');
const resultPrice = document.getElementById('result-price');

// Transition: Skin 2 becomes Skin 1
// We can just swap DOM elements content instantly

// Update IDs
skin1Id = next1.id;
skin2Id = next2.id;
// Corrected: next2 comes from response

// Update Left Panel (was Skin 2, now becomes the base)
document.getElementById('img-1').src = next1.image;
document.getElementById('img-1-main').src = next1.image;
document.getElementById('name-1').innerText = next1.name;
document.getElementById('price-1').innerText = '$' + next1.price;

// Update Right Panel (New Challenger)
document.getElementById('img-2').src = next2.image;
document.getElementById('img-2-main').src = next2.image;
document.getElementById('name-2').innerText = next2.name;

// Reset Styles
rightPanel.classList.remove('bg-emerald-900/50', 'bg-red-900/50');
controls.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
resultPrice.classList.add('hidden');

// Note: next2 price is hidden, logic is handled in next check
}

/* Add simple float animation */
/* style tag logic handled in CSS or tailwind config, adding inline here for simplicity */
	</script>

	<style>
		@keyframes float {
			0% {
				transform: translateY(0px);
			}
			50% {
				transform: translateY(-10px);
			}
			100% {
				transform: translateY(0px);
			}
		}
		.animate-float {
			animation: float 4s ease-in-out infinite;
		}
	</style>
{% endblock %}
